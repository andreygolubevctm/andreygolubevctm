<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="false">
	<conversionRule conversionWord="servletctx" converterClass="com.ctm.logging.ServletContextConverter" />
	<property name="ENV" value="${spring.profiles.active:-LOCALHOST}"/>
    
    <appender name="stdout" class="ch.qos.logback.core.ConsoleAppender">
	    <Target>System.out</Target>
	    <encoder>
			<pattern>%d{yyyy-MM-dd HH:mm:ss} %-5p %c:%L:%X{transactionId}:%X{brandCode}:%X{verticalCode}:%X{correlationId} - %m%n</pattern>
		</encoder>
  	</appender>

	<appender name="AMQP" class="org.springframework.amqp.rabbit.logback.AmqpAppender">
		<applicationId>webctm</applicationId>
		<generateId>true</generateId>
		<charset>UTF-8</charset>
		<durable>true</durable>
		<exchangeName>logs</exchangeName>
		<deliveryMode>PERSISTENT</deliveryMode>
		<host>dev-vm-ken-ctm-elk-x1</host>
		<layout class="net.logstash.logback.layout.LogstashLayout">
			<fieldNames class="net.logstash.logback.fieldnames.ShortenedFieldNames"/>
			<includeContext>false</includeContext>
			<provider class="net.logstash.logback.composite.loggingevent">
				<includeMdcKeyName>transactionId</includeMdcKeyName>
				<includeMdcKeyName>brandCode</includeMdcKeyName>
				<includeMdcKeyName>verticalCode</includeMdcKeyName>
				<includeMdcKeyName>correlationId</includeMdcKeyName>
			</provider>
			<customFields>{"hostname":"${HOSTNAME}", "appname":"webctm"}</customFields>
			<provider class="net.logstash.logback.composite.loggingevent.LoggingEventPatternJsonProvider">
				<pattern>{"env":"${ENV}","context":"%servletctx"}</pattern>
			</provider>
			<provider class="net.logstash.logback.composite.loggingevent.ArgumentsJsonProvider"/>
		</layout>
	</appender>

	<appender name="SIFT" class="ch.qos.logback.classic.sift.SiftingAppender">
		<!-- in the absence of the class attribute, it is assumed that the
				desired discriminator type is
				ch.qos.logback.classic.sift.MDCBasedDiscriminator -->
		<discriminator>
			<key>loggerName</key>
			<defaultValue>default_xml</defaultValue>
		</discriminator>
		<sift>
			<appender name="FILE-${loggerName}" class="ch.qos.logback.core.FileAppender">
				<prudent>false</prudent>
				<!-- ${logLocation} comes from environmentConfigLocation properties file -->
				<file>${LOG_PATH}/${loggerName}.log</file>
				<encoder>
					<pattern>%d{yyyy-MM-dd HH:mm:ss} - %msg%n</pattern>
				</encoder>
			</appender>
		</sift>
	</appender>
	
	<appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
		<queueSize>500</queueSize>
		<appender-ref ref="SIFT" />
	</appender>

	<logger name="com.ctm.logging.XMLOutputWriter" additivity="false">
		<appender-ref ref="ASYNC" />
  	</logger>

	<logger name="log4j.logger.org.elasticsearch" level="INFO"/>

	<root level="info">
   		<appender-ref ref="stdout" />
		<if condition='!(p("ENV").equalsIgnoreCase("PRO") || p("ENV").equalsIgnoreCase("LOCALHOST"))'>
			<then>
				<appender-ref ref="AMQP" />
			</then>
		</if>
	</root>
	
</configuration>