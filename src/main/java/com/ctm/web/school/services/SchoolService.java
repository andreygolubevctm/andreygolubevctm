package com.ctm.web.school.services;

import com.ctm.httpclient.Client;
import com.ctm.httpclient.RestSettings;
import com.ctm.web.school.model.School;
import com.ctm.web.school.model.Schools;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import rx.schedulers.Schedulers;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class SchoolService {
    public static final String MOCK_RESPONSE = "<option value=\"AAHD\">Academy of Advanced Hair Design/Vibe College</option><option value=\"ACA\">Actors Centre Australia</option><option value=\"ACAD\">Academique</option><option value=\"ACC\">Advanced Careers College</option><option value=\"ACCIT\">Australian College of Commerce & IT</option><option value=\"ACFE\">Australian Centre of Further Education</option><option value=\"ACIC\">ACIC/Austrlian College Info Centre</option><option value=\"ACNT\">Australian College of Natural Therapies</option><option value=\"ACPE\">Australian College of Physical Education</option><option value=\"ACPL\">American College</option><option value=\"ACST\">Australian College of Sports Therapy</option><option value=\"ADA\">Australian Defence Force Academy</option><option value=\"AECE\">Academy of early Childhood Education</option><option value=\"AFTR\">Australian Film, Television and Radio School</option><option value=\"AFTT\">Academy of Film, Theatre & Television</option><option value=\"AIBT\">Australia Institute of Business and Technology</option><option value=\"AIC\">Australian Ideal College (Ideal College)</option><option value=\"AIR\">Air Academy, British Aerospace Flight Training</option><option value=\"AISI\">Australian Industrial Systems Institute</option><option value=\"AMES\">Australian Management & Education Services</option><option value=\"AMTH\">AMT Helicopters</option><option value=\"ANIT\">Australian NIT College</option><option value=\"AOU\">Australian Online Institute</option><option value=\"APIC\">Asia Pacific International College</option><option value=\"APMB\">College of Business and Communication - Brisbane</option><option value=\"APMS\">College of Business and Communication - Sydney</option><option value=\"ASC\">Australian School of Commerce</option><option value=\"ASHC\">Ashton College</option><option value=\"ASS\">Airobate School/ Bankstown - Sydney</option><option value=\"AWA\">Australian Wings Academy</option><option value=\"AXCE\">Axcent - School of English</option><option value=\"BBSGA\">Billy Blue School of Graphic Arts</option><option value=\"BES\">Brighton Educational Services</option><option value=\"BI\">Burnet Institute</option><option value=\"BIC\">Barton International College</option><option value=\"CA\">College Australia</option><option value=\"CACT\">College - Theology</option><option value=\"CAM\">College - Australian Maritime</option><option value=\"CATD\">College - Atkinson Training & Development</option><option value=\"CAVO\">College - Avondale</option><option value=\"CB\">College - Batchelor</option><option value=\"CE\">Clinton Education/Institute</option><option value=\"CG\">College - Gatton</option><option value=\"CHC\">College- Christian Heritage</option><option value=\"CHIL\">College - Hillsong International Leadership</option><option value=\"CKVBV\">College - KVB of Visual Communication</option><option value=\"CLS\">College of Law - Sydney</option><option value=\"CMMN\">College - Natural Nedicine Melbourne</option><option value=\"CMN\">Conservatorium of Music - Newcastle</option><option value=\"CMS\">Conservatorium of Music - Sydney</option><option value=\"CMT\">College - Moore Theological</option><option value=\"CNM\">College - Natural Medicine SA</option><option value=\"CPBC\">College - Passmores Business College</option><option value=\"CPS\">College - Photography Studies</option><option value=\"CQA\">College - Queensland Art</option><option value=\"CQU\">Central Queensland University</option><option value=\"CSC\">University - Sunshine Coast</option><option value=\"CSCD\">College - Divinity (Sydney)</option><option value=\"CSJ\">College - St Johns</option><option value=\"CTAS\">The Council of Tara Anglican School for girls</option><option value=\"CVAH\">College - Agriculture & Horticulture (Victorian)</option><option value=\"DEG\">Dynamic Edication Group TA Keystone</option><option value=\"DFC\">DFC Educational Institution</option><option value=\"EC\">Educare College</option><option value=\"ECA\">Education Centre of Australia</option><option value=\"EDUC\">STP Default Education Institution</option><option value=\"EE\">Entrepreneur Education</option><option value=\"EGP\">Evulate Group</option><option value=\"EIEP\">Everest Institute of Education</option><option value=\"FIA\">Fitness Institute of Australia - Sydney NSW</option><option value=\"GBC\">George Brown College</option><option value=\"GBCA\">Global Business College of Australia</option><option value=\"GET\">Gamma Education & Training</option><option value=\"GI\">Glen Institute</option><option value=\"HACT\">High Schools - Australian Capital Territory</option><option value=\"HIC\">Harward International College</option><option value=\"HNSW\">High Schools - New South Wales</option><option value=\"HNT\">High Schools - Northern Territory</option><option value=\"HQLD\">High Schools - Queensland</option><option value=\"HSA\">High Schools - South Australia</option><option value=\"HTAS\">High Schools - Tasmania</option><option value=\"HVIC\">High Schools - Victoria</option><option value=\"HWA\">High Schools - Western Australia</option><option value=\"IBMA\">Institute of Business and Management Aust</option><option value=\"ICM\">International College of Melbourne</option><option value=\"ICMS\">International College of Management Sydney</option><option value=\"INT\">International Nurse Training</option><option value=\"ITC\">Institute of Technology - Canberra</option><option value=\"ITHEA\">ITHEA Corporation Pty Ltd</option><option value=\"ITS\">Institute of Technology - Swinburn</option><option value=\"JMC\">JMC Academy</option><option value=\"LI\">Lonsdale Institute</option><option value=\"LINX\">Linx Institute</option><option value=\"LUE\">Level Up English</option><option value=\"MAS\">Macarthur Anglican School</option><option value=\"MC\">Macleay College</option><option value=\"MCC\">Melbourne City College</option><option value=\"MCE\">The Melbourne College of English</option><option value=\"MEGA\">Macquarie Education Group Australia</option><option value=\"MGP\">Merage Group</option><option value=\"MINT\">Mint International College</option><option value=\"MIT\">Menzies Institute of Technology</option><option value=\"MIV\">Mercury Institute of Victoria</option><option value=\"MKBTC\">Madam Korner Beauty Therapy College</option><option value=\"MMCM\">Melba Memorial Conservatorium of Music</option><option value=\"NAISD\">National Aboriginal & Islander Skills Develop Ass.</option><option value=\"NAS\">National Art School</option><option value=\"NIDA\">National Institute of Dramatic Art</option><option value=\"NIT\">Nova Institute of Technology</option><option value=\"NOVA\">Nova Institute of Technology</option><option value=\"NPP\">National People Power/Kensington Institute</option><option value=\"NW\">Northwest</option><option value=\"NYCP\">New York College</option><option value=\"NYFA\">New York Film Academy Australia</option><option value=\"OIC\">Orange International College</option><option value=\"OLA\">Open Learning Australia</option><option value=\"ORTI\">Overseas Registered Tertiary Institutions</option><option value=\"OTH\">Other</option><option value=\"PA\">Police Academy-Charles Sturt University-Goulbourne</option><option value=\"QC\">Queensford College</option><option value=\"QCM\">Queensland Conservatorium of Music</option><option value=\"QIHE\">Queensland Institute of Health Education</option><option value=\"QISG\">Queensland International Study Group</option><option value=\"QTHC\">Quality Training and Hospitality College</option><option value=\"RID\">Rotary International District 9810</option><option value=\"RIEI\">Raising International Education & Immigration</option><option value=\"RMIT\">Institute of Technology - Royal Melbourne</option><option value=\"RTOC\">RTO Connect</option><option value=\"SACE\">The South Australian College of English</option><option value=\"SBIT\">Southbank Institute of Technology</option><option value=\"SCEI\">Southern Cross Education Institute</option><option value=\"SCIA\">Special Circumstances Identified & Authorised</option><option value=\"SGDC\">St George Design Centre</option><option value=\"SIA\">Skills Institute Australia</option><option value=\"SIC\">Stanley International College</option><option value=\"SILK\">SILK Education and Training</option><option value=\"SILT\">Sydney Institute of Language Training</option><option value=\"SKIC\">Skyline International College</option><option value=\"SUT\">Swinburne University of Technology</option><option value=\"TCE\">The Tasmanian College of English</option><option value=\"TE\">Thomas Education as per JB</option><option value=\"TEDI\">True Education/Technical Edu Development Institute</option><option value=\"TNSW\">TAFE - New South Wales</option><option value=\"TNT\">TAFE - Northern Territory</option><option value=\"TQLD\">TAFE - Queensland</option><option value=\"TSA\">TAFE - South Australia</option><option value=\"TT\">TAFE - Tasmania</option><option value=\"TVIC\">TAFE - Victoria</option><option value=\"TWA\">TAFE - Western Australia</option><option value=\"UA\">University - Adelaide</option><option value=\"UAC\">University - Australian Catholic</option><option value=\"UAN\">University - Australian National</option><option value=\"UBU\">University - Ballarat</option><option value=\"UBUC\">University - Bond</option><option value=\"UC\">University - Canberra</option><option value=\"UCD\">University - Charles Darwin</option><option value=\"UCQ\">University - Central Queensland</option><option value=\"UCS\">University - Charles Sturt</option><option value=\"UCUT\">University - Curtin Technology</option><option value=\"UD\">University - Deakin</option><option value=\"UEC\">University - Edith Cowen</option><option value=\"UF\">University - Flinders (SA)</option><option value=\"UG\">University - Griffith</option><option value=\"UJCNQ\">University - James Cook (Northern QLD)</option><option value=\"UL7W\">University - Wollongong</option><option value=\"ULT\">University - Latrobe</option><option value=\"UM\">University - Monash</option><option value=\"UMAQ\">University - Macquarie</option><option value=\"UMB\">University - Melbourne</option><option value=\"UMURN\">University - Murdoch</option><option value=\"UN\">University - Newcastle</option><option value=\"UNC\">University - Capricornia Rockhampton</option><option value=\"UNDP\">University of Notre Dame - Perth</option><option value=\"UNDS\">University of Notre Dame - Sydney</option><option value=\"UNE\">University - New England</option><option value=\"UNSW\">University - New South Wales</option><option value=\"UNT\">University - Northern Territory</option><option value=\"UQ\">University - Queensland</option><option value=\"UQT\">University - Queensland Technology</option><option value=\"USA\">University - South Australia</option><option value=\"USC\">University - Southern Cross</option><option value=\"USQ\">University - Southern Queensland</option><option value=\"USYD\">University - Sydney</option><option value=\"UT\">University - Tasmania</option><option value=\"UTS\">University - Technology Sydney</option><option value=\"UVT\">University - Victorian Technology</option><option value=\"UWA\">University - Western Australia</option><option value=\"UWAIW\">UWA Irrigation & Water Resource Management</option><option value=\"UWS\">University - Western Sydney</option><option value=\"VICA\">Victorian Institute of Culinary Arts and Tech</option><option value=\"VIOT\">Victorian Institute of Technology</option><option value=\"VIVE\">Victory Institute of Vocational Education</option><option value=\"WAI\">William Angliss Institute</option><option value=\"WCE\">The Whitsundays College of English</option><option value=\"WEA\">New South Wales</option><option value=\"WI\">Wesley Institute</option><option value=\"WID\">Whitehouse Institute of Design</option><option value=\"WSC\">White Sands College</option><option value=\"ZBA\">Zenith Business Academy</option>";
    public static final String OPTION_TEMPLATE = "<option value=\"%s\">%s</option>";
    private static final Long TIMEOUT_IN_MILLISECONDS = 5000L;
    private static final Logger LOG = LoggerFactory.getLogger(SchoolService.class);
    @Autowired
    private Client<String, Schools> client;
    @Value("${school.service.url}")
    private String requestUrl;
    @Value("${school.service.mock:true}")
    private Boolean mockService;

    public String getSchoolsAsHtmlOptions() {
        if (mockService) {
            LOG.debug("Returning a mock response, to avoid the dodgy local SSL Certificate at NIB..");
            return MOCK_RESPONSE;
        } else {
            return getSchools()
                    .stream()
                    .map(school -> String.format(OPTION_TEMPLATE, school.getCode(), school.getCodeDescription()))
                    .collect(Collectors.joining());
        }
    }

    private List<School> getSchools() {
        LOG.debug("About to read the list of schools from {}", requestUrl);
        Schools schoolList = client.get(RestSettings.<String>builder()
                .response(Schools.class)
                .responseType(MediaType.APPLICATION_JSON)
                .url(requestUrl)
                .timeout(TIMEOUT_IN_MILLISECONDS)
                .retryAttempts(2)
                .build()).observeOn(Schedulers.io()).toBlocking().first();

        LOG.debug("Successfully read {} schools.", schoolList.getData().size());
        return schoolList.getData();
    }
}
