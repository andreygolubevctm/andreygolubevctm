(function(e){var t=(e.browser.msie?"paste":"input")+".mask";var n=window.orientation!=undefined;var r;e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"};e.fn.extend({caret:function(e,t){if(this.length==0)return;if(typeof e=="number"){t=typeof t=="number"?t:e;return this.each(function(){if(this.setSelectionRange){this.setSelectionRange(e,t)}else if(this.createTextRange){var n=this.createTextRange();n.collapse(true);n.moveEnd("character",t);n.moveStart("character",e);n.select()}})}else{if(this[0].setSelectionRange){e=this[0].selectionStart;t=this[0].selectionEnd}else if(document.selection&&document.selection.createRange){var n=document.selection.createRange();e=0-n.duplicate().moveStart("character",-1e5);t=e+n.text.length}return{begin:e,end:t}}},unmask:function(){return this.trigger("unmask")},mask:function(i,s){if(!i&&this.length>0){var o=e(this[0]);return o.data(e.mask.dataName)()}s=e.extend({placeholder:"_",completed:null},s);var u=e.mask.definitions;var a=[];var f=i.length;var l=null;var c=i.length;e.each(i.split(""),function(e,t){if(t=="?"){c--;f=e}else if(u[t]){a.push(new RegExp(u[t]));if(l==null)l=a.length-1}else{a.push(null)}});return this.trigger("unmask").each(function(){function d(e){while(++e<=c&&!a[e]);return e}function v(e){while(--e>=0&&!a[e]);return e}function m(e,t){if(e<0)return;for(var n=e,r=d(t);n<c;n++){if(a[n]){if(r<c&&a[n].test(h[r])){h[n]=h[r];h[r]=s.placeholder.length>1?s.placeholder.charAt(n):s.placeholder}else break;r=d(r)}}E();o.caret(Math.max(l,e))}function g(e){for(var t=e;t<c;t++){var n=s.placeholder.length>1?s.placeholder.charAt(t):s.placeholder;if(a[t]){var r=d(t);var i=h[t];h[t]=n;if(r<c&&a[r].test(i))n=i;else break}}}function y(e){var t=e.which;if(t==8||t==46||n&&t==127){var r=o.caret(),i=r.begin,s=r.end;if(s-i==0){i=t!=46?v(i):s=d(i-1);s=t==46?d(s):s}w(i,s);m(i,s-1);return false}else if(t==27){o.val(p);o.caret(0,S());return false}}function b(e){var t=e.which,n=o.caret();if(e.ctrlKey||e.altKey||e.metaKey||t<32){return true}else if(t){if(n.end-n.begin!=0){w(n.begin,n.end);m(n.begin,n.end-1)}var r=d(n.begin-1);if(r<c){var i=String.fromCharCode(t);if(a[r].test(i)){g(r);h[r]=i;E();var u=d(r);o.caret(u);if(s.completed&&u>=c)s.completed.call(o)}}return false}}function w(e,t){for(var n=e;n<t&&n<c;n++){if(a[n])h[n]=s.placeholder.length>1?s.placeholder.charAt(n):s.placeholder}}function E(){return o.val(h.join("")).val()}function S(e){var t=o.val();var n=-1;for(var r=0,i=0;r<c;r++){if(a[r]){h[r]=s.placeholder.length>1?s.placeholder.charAt(r):s.placeholder;while(i++<t.length){var u=t.charAt(i-1);if(a[r].test(u)){h[r]=u;n=r;break}}if(i>t.length)break}else if(h[r]==t.charAt(i)&&r!=f){i++;n=r}}if(!e&&n+1<f){o.val("");w(0,c)}else if(e||n+1>=f){E();if(!e)o.val(o.val().substring(0,n+1))}return f?r:l}var o=e(this);var h=e.map(i.split(""),function(e,t){if(e!="?"){return u[e]?s.placeholder.length>1?s.placeholder.charAt(t):s.placeholder:e}});var p=o.val();o.data(e.mask.dataName,function(){return e.map(h,function(e,t){return a[t]&&e!=(s.placeholder.length>1?s.placeholder.charAt(t):s.placeholder)?e:null}).join("")});if(!o.attr("readonly"))o.one("unmask",function(){o.unbind(".mask").removeData(e.mask.dataName)}).bind("focus.mask",function(){clearTimeout(r);var e,t;p=o.val();e=S();r=setTimeout(function(){E();if(e==i.length){o.caret(0,e)}else{o.caret(e)}},10)}).bind("blur.mask",function(){S();if(o.val()!=p)o.change()}).bind("keydown.mask",y).bind("keypress.mask",b).bind(t,function(){setTimeout(function(){o.caret(S(true))},0)});S()})}})})(jQuery)