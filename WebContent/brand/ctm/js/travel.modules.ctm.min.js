/*!
 * CTM-Platform v0.8.3
 * Copyright 2014 Compare The Market Pty Ltd
 * http://www.comparethemarket.com.au/
 */


!function(a){function b(){a(document).ready(function(){c();var b=null;f.site.isFromBrochureSite===!0?b=i.detailsStep.navigationId:((f.site.journeyStage.length>0&&"amend"===f.site.pageAction||"load"===f.site.pageAction)&&(f.modules.journeyEngine.loadingShow("retrieving your quote information"),f.modules.travelReloadQuote.loadQuote()),"results"===f.site.pageAction&&(f.modules.form.markInitialFieldsWithValue(a("#mainform")),b=i.resultsStep.navigationId)),f.modules.journeyEngine.configure({startStepId:b,steps:_.toArray(i)});var d=f.modules.transactionId.get();f.messaging.publish(g.tracking.EXTERNAL,{method:"trackQuoteEvent",object:{action:"Start",transactionID:d}}),f.site.isNewQuote===!1&&f.messaging.publish(g.tracking.EXTERNAL,{method:"trackQuoteEvent",object:{action:"Retrieve",transactionID:d}});var h=a("#more-info-template");h.length>0&&(e=_.template(h.html()))})}function c(){var b={title:"Travel Details",navigationId:"start",slideIndex:0,externalTracking:{method:"trackQuoteForms",object:f.modules.travel.getTrackingFieldsObject},onInitialise:function(){f.modules.travelCountrySelection.initCountrySelection()},onBeforeEnter:function(){},onBeforeLeave:function(){}},c={title:"Results",navigationId:"results",slideIndex:1,externalTracking:{method:"trackQuoteForms",object:f.modules.travel.getTrackingFieldsObject},onInitialise:function(){f.modules.travelResults.initPage(),f.modules.travelSummaryText.initSummaryText(),f.modules.travelMoreInfo.initMoreInfo(),f.modules.travelSorting.initSorting(),f.modules.partnerTransfer.initTransfer()},onBeforeEnter:function(){a("#resultsPage").addClass("hidden"),f.modules.travelSummaryText.updateText()},onAfterEnter:function(){f.modules.travelResults.get()},onAfterLeave:function(){}};i={detailsStep:b,resultsStep:c}}function d(){try{var b=("Y"===a("input[name=travel_marketing]","#mainform").val()?"Y":"N","Y"===a("input[name=travel_marketing]:checked","#mainform").val()?"Y":"N"),c=f.modules.transactionId.get(),d=f.modules.journeyEngine.getCurrentStepIndex(),e=f.modules.journeyEngine.getFurtherestStepIndex(),g=a("#travel_policyType").val(),h=a("#travel_email").val(),i="",j="",k="";switch(d){case 0:k="travel details";break;case 1:k="travel results"}f.modules.moreInfo.isModalOpen()&&(k="travel more info"),"S"==g?(a("input.destcheckbox:checked").each(function(){i+=","+a(this).val()}),i=i.substring(1),j="Single Trip"):j="Annual Policy";var l={vertical:"travel",actionStep:k,transactionID:c,quoteReferenceNumber:c,email:h,marketOptIn:b};return e>f.modules.journeyEngine.getStepIndex("start")&&_.extend(l,{email:h,destinationCountry:i,travelInsuranceType:j,marketOptIn:b}),l}catch(m){return!1}}var e,f=window.meerkat,g=f.modules.events,h={WEBAPP_LOCK:"WEBAPP_LOCK",WEBAPP_UNLOCK:"WEBAPP_UNLOCK"},i=null;f.modules.register("travel",{init:b,events:h,getTrackingFieldsObject:d})}(jQuery),function(a){function b(){g.on("change",function(){a(this).is(":checked")?(d.attr("required","required").valid(),e.attr("required","required").valid(),f.attr("required","required").valid()):(d.removeAttr("required").valid(),e.removeAttr("required").valid(),f.removeAttr("required").valid())})}function c(){a(document).ready(function(){d=a("#travel_firstName"),e=a("#travel_surname"),f=a("#travel_email"),g=a("#travel_marketing"),d.removeAttr("required"),e.removeAttr("required"),f.removeAttr("required"),b()})}{var d,e,f,g,h=window.meerkat;h.modules.events,h.logging.info}h.modules.register("travelContactDetails",{init:c})}(jQuery),function(a){function b(){var a=$destinationsFieldset.find(".error-field");a.length>0&&a.remove(),e.val($destinationsFieldset.find(".destcheckbox:checked").length>0?"1":""),e.valid()}function c(){a(document).ready(function(){$destinationsFieldset=a(".travel_details_destinations"),e=a("#travel_destination"),f=a(".destcheckbox"),d()})}function d(){f.on("change",function(){g.modules.travelCountrySelection.updateCountries()})}{var e,f,g=window.meerkat;g.modules.events,g.logging.info}g.modules.register("travelCountrySelection",{initCountrySelection:c,updateCountries:b})}(jQuery),function(a){"use strict";function b(a,b){function c(a){return 10>a?"0"+a:a}"undefined"==typeof b&&(b=!1);var d=new Date(a);return b?[d.getFullYear(),c(d.getMonth()+1),c(d.getDate())].join("-"):[c(d.getDate()),c(d.getMonth()+1),d.getFullYear()].join("/")}function c(){l=s,m=new Date(l.toString()),m.setYear(parseInt(m.getFullYear())+1),p=s,q=new Date(p.toString()),q.setYear(parseInt(q.getFullYear())+1)}function d(){c(),i.datepicker({startDate:l,endDate:m}),i.siblings(".dateinput-nativePicker").find("input").attr("min",b(l,!0)).attr("max",b(m,!0)),j.datepicker({startDate:p,endDate:q}),j.siblings(".dateinput-nativePicker").find("input").attr("min",b(p,!0)).attr("max",b(q,!0))}function e(){k=i.datepicker("getDate"),"Invalid Date"!==k.toString()&&(p=new Date(k.toString()),q=new Date(p.toString()),q.setYear(parseInt(q.getFullYear())+1),j.datepicker("setStartDate",p).datepicker("setEndDate",q),j.siblings(".dateinput-nativePicker").find("input").attr("min",b(p,!0)).attr("max",b(q,!0)),j.rules("remove","maxDateEUR"),j.rules("add",{maxDateEUR:b(q),messages:{maxDateEUR:"The return date should be equal to or before one year after the departure date (i.e. "+b(q)+")"}}))}function f(){k=i.datepicker("getDate"),o=j.datepicker("getDate"),n=new Date(k.toString()),n.setYear(parseInt(n.getFullYear())+1),o>n&&(r.modules.formDateInput.populate(j,b(n)),j.datepicker("update",n))}function g(){i.on("hide serialised.meerkat.formDateInput",function(){f(),e()}),j.on("hide serialised.meerkat.formDateInput",function(){i.blur()})}function h(){a(document).ready(function(){i=a("#travel_dates_fromDate"),j=a("#travel_dates_toDate"),i.datepicker({orientation:"top right"}),j.datepicker({orientation:"top right"}),d(),g()})}var i,j,k,l,m,n,o,p,q,r=window.meerkat,s=(r.modules.events,r.logging.info,new Date);r.modules.register("datesSelection",{init:h})}(jQuery),function(a){function b(){var b={container:l,modalOptions:{className:"modal-breakpoint-wide modal-tight bridgingContainer",openOnHashChange:!1,leftBtn:{label:"All Products",icon:'<span class="icon icon-arrow-left"></span>',callback:function(b){a(b.currentTarget).closest(".modal").modal("hide")}}},runDisplayMethod:d,onBeforeShowBridgingPage:null,onBeforeShowTemplate:null,onBeforeShowModal:null,onAfterShowModal:h,onAfterShowTemplate:null,onBeforeHideTemplate:null,onAfterHideTemplate:null,onClickApplyNow:g,onBeforeApply:null,onApplySuccess:null,retrieveExternalCopy:f};j.modules.moreInfo.initMoreInfo(b),e(),c()}function c(){}function d(){j.modules.moreInfo.showModal(),j.modules.address.appendToHash("moreinfo")}function e(){j.messaging.subscribe(k.device.STATE_ENTER_XS,function(){j.modules.moreInfo.isModalOpen()&&j.modules.moreInfo.close()}),j.messaging.subscribe(k.device.STATE_LEAVE_XS,function(){j.modules.moreInfo.isModalOpen()&&j.modules.moreInfo.close()})}function f(b){return a.Deferred(function(c){var d=[],e={};return a.each(b.info,function(a){""!==this.order&&(e[this.order]=a),d.push([b.info[a].desc,a])}),b.sorting=j.modules.travelMoreInfo.arraySort(e,d),j.modules.moreInfo.setDataResult(b),c.resolveWith(this,[b]).promise()})}function g(a,b){var c={product:a,applyNowCallback:b};j.modules.partnerTransfer.transferToPartner(c)}function h(){j.messaging.publish(k.tracking.EXTERNAL,{method:"trackQuoteForms",object:_.bind(j.modules.travel.getTrackingFieldsObject,this,!0)})}function i(b,c){var d=[];return b.length>0?(a.each(b,function(e){a.each(c,function(a){b[e]==c[a][1]&&d.push([c[a][0],c[a][1]])})}),d):(c.sort(),c)}{var j=window.meerkat,k=j.modules.events,l=a(".bridgingContainer"),m={travelMoreInfo:{}};m.travelMoreInfo}j.modules.register("travelMoreInfo",{initMoreInfo:b,events:m,runDisplayMethod:d,arraySort:i})}(jQuery),function(a){function b(){a(document).ready(function(){g=a("body,html"),$footer=a("#footer"),h=a(".morePromptContainer"),contentBottom=$footer.offset().top-a(window).height(),k||"xs"==i.modules.deviceMediaState.get()?k&&_.delay(d,600):e(),c()})}function c(){i.messaging.subscribe(j.device.STATE_LEAVE_XS,function(){k||e()})}function d(){var b="innerHeight"in window?window.innerHeight:document.documentElement.offsetHeight;b+a(window).scrollTop()>=a(".resultsContainer").outerHeight()?h.fadeOut():h.fadeIn()}function e(){h.fadeIn(),k=!0,a(window).scroll(function(){clearTimeout(a.data(this,"scrollCheck")),a.data(this,"scrollCheck",setTimeout(d,150))}),a(document.body).on("click",".morePromptLink",function(){var b="top".toLowerCase(),c={},d=$footer.offset().top-a(window).height();"bottom"==b&&(d+=$footer.outerHeight(!0)),c.scrollTop=d,g.stop(!0,!0).animate(c,800)})}function f(){i.messaging.subscribe(j.RESULTS_DATA_READY,function(){i.modules.travelMorePrompt.initPrompt()})}var g,h,i=window.meerkat,j=i.modules.events,k=!1;i.modules.register("travelMorePrompt",{init:f,initPrompt:b})}(jQuery),function(){function a(){}function b(){var a=d(window.location.search),b="vertical=travel&action=load&id="+a.id+"&hash="+a.hash+"&type="+a.type+"&vertical=TRAVEL&transactionId="+a.id;e.modules.comms.post({url:"ajax/json/remote_load_quote.jsp",data:b,cache:!1,useDefaultErrorHandling:!1,errorLevel:"fatal",timeout:3e4,onError:c,onSuccess:function(a){window.location=a.result.destUrl+"&ts="+Number(new Date)}})}function c(a,b,c,d,f){stateSubmitInProgress=!1,e.messaging.publish(moduleEvents.WEBAPP_UNLOCK,{source:"loadQuote"}),e.modules.errorHandling.error({message:"An error occurred when attempting to retrieve your quotes",page:"travelReloadQuote.js:loadQuote()",errorLevel:"warning",description:"Ajax request to remote_load_quote.jsp failed to return a valid response: "+c,data:f})}function d(a){if(a.length>1){for(var b,c={},d=0,e=a.substr(1).split("&");d<e.length;d++)b=e[d].split("="),c[decodeURIComponent(b[0])]=b.length>1?decodeURIComponent(b[1]):"";return c}}{var e=window.meerkat;e.modules.events}e.modules.register("travelReloadQuote",{init:a,loadQuote:b})}(jQuery),function(a){function b(){c(),Compare.init(),d()}function c(){try{Results.init({url:"ajax/json/travel_quote_results.jsp",runShowResultsPage:!1,paths:{results:{list:"results.price"},productId:"productId",price:{premium:"price"},benefits:{cxdfee:"info.cxdfee.value",excess:"info.excess.value",medical:"info.medical.value",luggage:"info.luggage.value"},availability:{product:"available"}},show:{nonAvailableProducts:!1,unavailableCombined:!0},availability:{product:["equals","Y"]},render:{templateEngine:"_",dockCompareBar:!1},displayMode:"price",paginationTouchEnabled:!1,sort:{sortBy:"price.premium",sortDir:"asc"},frequency:"premium",animation:{results:{individual:{active:!1},delay:500,options:{easing:"swing",duration:1e3}},shuffle:{active:!0,options:{easing:"swing",duration:1e3}},filter:{reposition:{options:{easing:"swing"}}}},rankings:{triggers:["RESULTS_DATA_READY"],callback:l.modules.travelResults.rankingCallback,forceIdNumeric:!1,filterUnavailableProducts:!1}})}catch(a){Results.onError("Sorry, an error occurred initialising page","results.tag","meerkat.modules.travelResults.init(); "+a.message,a)}}function d(){l.messaging.subscribe(m.affix.AFFIXED,function(){k.css("margin-top","8px")}),l.messaging.subscribe(m.affix.UNAFFIXED,function(){k.css("margin-top","0")}),a(Results.settings.elements.resultsContainer).on("noFilteredResults",function(){Results.view.show()}),a(document).on("resultsReturned",function(){l.modules.utilities.scrollPageTo(a("header")),a(".featuresHeaders .expandable.expanded").removeClass("expanded").addClass("collapsed")}),a(document).on("resultsFetchStart",function(){l.modules.journeyEngine.loadingShow("...getting your quotes..."),k.removeClass("hidden"),Results.pagination.hide()}),a(document).on("resultsFetchFinish",function(){a(Results.settings.elements.page).show(),l.modules.journeyEngine.loadingHide(),"price"!==Results.getDisplayMode()?Results.pagination.show():a(document.body).removeClass("priceMode").addClass("priceMode");var b=0;a.each(Results.model.returnedProducts,function(){"Y"===this.available&&"CURR"!==this.productId&&b++}),0===b&&h()}),a(Results.settings.elements.resultsContainer).on("click",".result-row",f)}function e(a,b){var c={};return c["rank_premium"+b]=a.price,c["rank_productId"+b]=a.productId,_.isNumber(o)&&o>b&&(c["best_price"+b]=1,c["best_price_productName"+b]=a.name,c["best_price_excess"+b]=a.info.excess.text,c["best_price_medical"+b]=a.info.medical.text,c["best_price_cxdfee"+b]=a.info.cxdfee.text,c["best_price_luggage"+b]=a.info.luggage.text,c["best_price_price"+b]=a.priceText,c["best_price_url"+b]=a.quoteUrl),c}function f(b){if(a(Results.settings.elements.resultsContainer).hasClass("priceMode")!==!1&&"xs"===l.modules.deviceMediaState.get()){var c=a(b.target);c.hasClass("result-row")===!1&&(c=c.parents(".result-row")),"undefined"!=typeof c.attr("data-available")&&"Y"===c.attr("data-available")&&(l.modules.moreInfo.setProduct(Results.getResult("productId",c.attr("data-productId"))),l.modules.travelMoreInfo.runDisplayMethod())}}function g(){Results.get()}function h(){l.modules.dialogs.show({htmlContent:a("#no-results-content")[0].outerHTML})}function i(){var a={vertical:l.site.vertical,actionStep:l.site.vertical+" results",event:n};l.messaging.publish(m.tracking.EXTERNAL,{method:"trackQuoteList",object:a}),n="Refresh"}function j(){k=a("#resultsPage"),l.messaging.subscribe(m.RESULTS_RANKING_READY,i)}var k,l=window.meerkat,m=l.modules.events,n=(l.logging.info,"Load"),o=1;l.modules.register("travelResults",{init:j,initPage:b,get:g,showNoResults:h,rankingCallback:e})}(jQuery),function(a){function b(a){var b=a.attr("data-sort-type"),c=a.attr("data-sort-dir");if("undefined"!=typeof b&&"undefined"!=typeof c){b===Results.getSortBy()&&c===Results.getSortDir()&&(c="asc"===c?"desc":"asc",a.attr("data-sort-dir",c));var d=Results.sortBy(b,c);d?(e.parent("li").removeClass("active"),a.parent("li").addClass("active")):h("[travelSorting]","The sortBy or sortDir could not be set",setSortByReturn,setSortDirReturn)}else h("[travelSorting]","No data on sorting element")}function c(){f.messaging.subscribe(g.RESULTS_SORTED,function(){f.messaging.publish(g.WEBAPP_UNLOCK)}),e.on("click",function(c){$clicked=a(c.target),$clicked.is("a")||($clicked=$clicked.closest("a")),$clicked.hasClass("disabled")||(f.messaging.publish(g.WEBAPP_LOCK),_.defer(function(){b($clicked)}))}),f.messaging.subscribe(g.WEBAPP_LOCK,function(){e.addClass("inactive").addClass("disabled")}),f.messaging.subscribe(g.WEBAPP_UNLOCK,function(){e.removeClass("inactive").removeClass("disabled")})}function d(){a(document).ready(function(){e=a("[data-sort-type]"),"undefined"==typeof Results&&f.logging.exception("[travelSorting]","No Results Object Found!")})}{var e,f=window.meerkat,g=f.modules.events,h=(f.logging.info,f.logging.error),i=(f.logging.exception,{travelSortings:{}});i.travelSorting}f.modules.register("travelSorting",{init:d,initSorting:c,events:i})}(jQuery),function(a){function b(){var b="<span>"+("sm"!==l.modules.deviceMediaState.get()?"Your quote":"Quote")+'</span> is based on: <span class="highlight">',c=j.val(),d=k.val(),e=a(".destcheckbox:checked").length;if(b+=c+" adult"+(1==c?"":"s"),d>0&&(b+=" and "+d+" child"+(1==d?"":"ren")),"S"==$policytype.val()){if(b+='</span> <span class="optional">travelling</span> to <span class="highlight">',i.is(":checked"))b+="any country";else if(e>1)b+=e+" destinations";else{var m=a(".destcheckbox:checked").first().attr("id");b+=a("label[for="+m+"]").text()}var n=g.val().split("/"),o=h.val().split("/"),p=new Date(n[2],n[1]-1,n[0]),q=new Date(o[2],o[1]-1,o[0]),r=864e5,s=1+Math.ceil((q.getTime()-p.getTime())/r);b+="</span> for <span class='highlight'>"+s+" days"}else b+="</span> travelling <span class='highlight'>multiple times in one year";f.html(b+"</span>").fadeIn()}function c(){f=a(".resultsSummaryPlaceholder"),g=a("#travel_dates_fromDate"),h=a("#travel_dates_toDate"),i=a("#travel_destinations_do_do"),j=a("#travel_adults"),k=a("#travel_children"),$policytype=a("#travel_policyType"),d()}function d(){l.messaging.subscribe(m.device.STATE_ENTER_SM,function(){"results"===l.modules.journeyEngine.getCurrentStep().navigationId&&b()}),l.messaging.subscribe(m.device.STATE_ENTER_MD,function(){"results"===l.modules.journeyEngine.getCurrentStep().navigationId&&b()})}function e(){}{var f,g,h,i,j,k,l=window.meerkat,m=l.modules.events;l.logging.info}l.modules.register("travelSummaryText",{init:e,initSummaryText:c,updateText:b})}(jQuery);
//# sourceMappingURL=travel.modules.ctm.min.map