/*!
 * CTM-Platform v0.8.3
 * Copyright 2015 Compare The Market Pty Ltd
 * http://www.comparethemarket.com.au/
 */


!function(a,b,c){function d(){o.defaults.expires=r.cookieLifetime,o.defaults.domain=r.cookieDomain,o.defaults.path=r.cookiePath,r.cookieSecure&&(o.defaults.secure=r.cookieSecure)}function e(c){if(!f()){var d=b.createElement("iframe");return d.src=c||r.fBase+r.fPath,d.name=r.fName,d.id=r.fName,d.style.display="none",d.attachEvent?d.attachEvent("onload",function(){n.iFrameReady=!0,p.eventTrigger("_CtMH.ready")}):d.onload=function(){n.iFrameReady=!0,p.eventTrigger("_CtMH.ready")},b.body.appendChild(d),n.iFrameExists=!0,s("iFrame Created"),a.frames[r.fName]}}function f(){return a!=a.top?(s(f.caller.name," called INSIDE iframe",a.name),!0):(s(f.caller.name," called OUTSIDE iframe",a.name),!1)}function g(){for(var a=[],b=o.all(),c=p.collateCookiesIntoTierArrays(b),d=p.ObjectKeys(c),e=0;e<d.length;e++)for(var f=d[e],g=c[f],h=p.ObjectKeys(g),i=0;i<h.length;i++)for(var j=h[i],k={},l=g[j].length-1;l>=0;l--){var m,n,q=g[j][l],r=p.ObjectKeys(q);m=r[0],n=q[m];var t=n.v||"";if(0!==t.length){var u=n.pid||"",v=t+u;if("undefined"!=typeof k[v]){var w=k[v],x=p.ObjectKeys(w),y=x[0],z=w[y].u||w[y].c,A=n.u||n.c;A>z&&(k[v]=q,a.push(y)),z>=A&&a.push(m)}else k[v]=q}}s("_purge","deleteBatch:",a,"from original:",b),o.remove(a)}function h(){var a=[];if(f()&&r.recovery){s("_recoverFailed","Checking");var b=p.getAllCTMHCookiesAsString(),c=~b.lastIndexOf("sent#false");if(c){s("_recoverFailed","There is a failed cookie.");for(var d=o.all(),e=p.ObjectKeys(d),g=0;g<e.length;g++){var h=e[g],i=~d[h].lastIndexOf("sent#false"),j=~d[h].indexOf("test#1");if(r.asTest===!!j){var k={};i&&(s("_recoverFailed","Failed cookie for "+h+" matches asTest state"),k[h]=p.cookieValToObject(d[h]),a.push(k))}}var l=a.length;if(0===l)return void s("_recoverFailed","No failed candidates meet asTest state, but do exist.");l>1&&a.sort(p.latestDateSortCookieObjectArray);var m,n,q=a[0];s("_recoverFailed","Failed cookie:",q);var t=p.ObjectKeys(q),u=t[0];m=u.split("_CtMH")[1],n=q[u];var v=u,w=function(a,b){if("success"===b){s("Request success:",b,a.status,a);var c=a.responseText.toString().replace(/\s|\r|\n/g,"");if('{"success":true}'===c){n.sent=!0;var d=p.objectToStringVal(n);p.setCookie(v,d),s("Previously Failed Cookie "+v+" accepted at endpoint. Marked sent.")}else'{"success":"clear"}'===c&&(o.remove(v),s("Previously Failed Cookie "+v+" deleted at endpoint's request."))}else s("Request failed:",b,a.status,a)};s("_recoverFailed","Sending "+v),p.sendRequest(r.endp,w,p.objectToStringVal(n,"formdata"))}else s("_recoverFailed","No previously failed candidate sessions.");r.recovery=!1}else s("Recovery check was already run, or disabled in options.")}function i(c,d){f();var e,g=""+c;"undefined"!=typeof d?e=d:(e=b.getElementById(r.fName),s("_sendPostMessage","fName was:",r.fName,"and got",e,"contentWindow is:",e.contentWindow)),"undefined"!=typeof e.contentWindow.postMessage?(e.contentWindow.postMessage(g,"*"),s("_sendPostMessage","Sent:",g)):s("_sendPostMessage","ERROR: POST MESSAGE NOT SUPPORTED",r.fName,a.frames[r.fName],a.frames[r.fName])}function j(a){f(),s("_receivePostMessage","Inside Receive Origin:",a.origin),s("_receivePostMessage","Inside Receive Data:",a.data);var b=a.data,c=b.split("="),d=c[0],e=c[1].split("|"),g=~c[0].indexOf("#");if(g)for(var h=0;h<e.length;h++)e[h].split("#").length>1&&(s("_receivePostMessage","Found an object to turn into params:",e[h]),e[h]=p.cookieValToObject(e[h]));t[d].apply(null,e)}function k(a){n.onReadyWasFired?"function"==typeof a&&a():p.eventListen("_CtMH.ready",function(){n.onReadyWasFired=!0,"function"==typeof a&&a()})}function l(){if(!r.manual)if(f())a.addEventListener?a.addEventListener("message",j,!1):a.attachEvent?a.attachEvent("onmessage",j):b.attachEvent("onmessage",j);else{e()}}var m={version:"1.0.0",manual:!1,start:!1,debug:!0,asTest:!1,fName:"CtMH_iframe",fBase:"https://handover.secure.comparethemarket.com.au/ctm/",fPath:"external/handover/iframe.html",endp:"https://handover.secure.comparethemarket.com.au/ctm/handover/confirm",timeout:5e3,recovery:!0,cookieLifetime:30,cookieDomain:c,cookiePath:c,cookieSecure:c},n={iFrameExists:!1,iFrameReady:!1,onReadyWasFired:!1,confirmSuccess:c,cookieAverse:!1},o=function(a,b){var c=function(){return c.get.apply(c,arguments)},d=c.utils={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isPlainObject:function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},toArray:function(a){return Array.prototype.slice.call(a)},getKeys:Object.keys||function(a){var b=[],c="";for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},escape:function(a){return String(a).replace(/[,;"\\=\s%]/g,function(a){return encodeURIComponent(a)})},retrieve:function(a,b){return null==a?b:a}};return c.defaults={},c.expiresMultiplier=86400,c.set=function(c,e,f){if(d.isPlainObject(c))for(var g in c)c.hasOwnProperty(g)&&this.set(g,c[g],e);else{f=d.isPlainObject(f)?f:{expires:f};var h=f.expires!==b?f.expires:this.defaults.expires||"",i=typeof h;"string"===i&&""!==h?h=new Date(h):"number"===i&&(h=new Date(+new Date+1e3*this.expiresMultiplier*h)),""!==h&&"toGMTString"in h&&(h=";expires="+h.toGMTString());var j=f.path||this.defaults.path;j=j?";path="+j:"";var k=f.domain||this.defaults.domain;k=k?";domain="+k:"";var l=f.secure||this.defaults.secure?";secure":"";a.cookie=d.escape(c)+"="+d.escape(e)+h+j+k+l}return this},c.remove=function(a){a=d.isArray(a)?a:d.toArray(arguments);for(var b=0,c=a.length;c>b;b++)this.set(a[b],"",-1);return this},c.empty=function(){return this.remove(d.getKeys(this.all()))},c.get=function(a,c){c=c||b;var e=this.all();if(d.isArray(a)){for(var f={},g=0,h=a.length;h>g;g++){var i=a[g];f[i]=d.retrieve(e[i],c)}return f}return d.retrieve(e[a],c)},c.all=function(){if(""===a.cookie)return{};for(var b=a.cookie.split("; "),c={},d=0,e=b.length;e>d;d++){var f=b[d].split("=");c[decodeURIComponent(f[0])]=decodeURIComponent(f[1])}return c},c.enabled=function(){if(navigator.cookieEnabled)return!0;var a="_"===c.set("_","_").get("_");return c.remove("_"),a},c}(b),p={};p.ObjectKeys=Object.keys||function(a){var b=[],c="";for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},p.extend=function(){for(var a=1;a<arguments.length;a++)for(var b=p.ObjectKeys(arguments[a]),c=0;c<b.length;c++)arguments[0][b[c]]=arguments[a][b[c]];return arguments[0]},p.b36_Date=function(a){return Math.round(a.getTime()/1e3).toString(36)},p.b36_toInt=function(a){return Math.round(1e3*parseInt(a,36))},p.b36_toDate=function(a){return new Date(p.b36_toInt(a))},p._XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],p.createXMLHTTPObject=function(){for(var a=!1,b=0;b<p._XMLHttpFactories.length;b++){try{a=p._XMLHttpFactories[b]()}catch(c){continue}break}return a},p.sendRequest=function(a,b,c,d){var e=p.createXMLHTTPObject();if(e){var f=c?"POST":"GET",g=!0,h=d||parseInt(r.timeout,10),i=!1;e.open(f,a,g),e.timeout=h+1e3,c&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded");var j=setTimeout(function(){i=!0,e.abort()},h);e.onreadystatechange=function(){if(4==e.readyState)if(0===e.status&&i)b(e,"timeout");else{if(200!=e.status&&304!=e.status)return clearTimeout(j),void b(e,"error");clearTimeout(j),b(e,"success")}},4!=e.readyState&&e.send(c)}},p.eventListen=function(a,c){f(),b.addEventListener?b.addEventListener(a,c,!1):b.documentElement.attachEvent("onpropertychange",function(b){b.propertyName==a&&c()})},p.eventTrigger=function(a){if(f(),b.createEvent){var c=b.createEvent("Event");c.initEvent(a,!0,!0),b.dispatchEvent(c)}else b.documentElement[a]++};p.objectToStringVal=function(a,b){var c,d,e,f="";b=b||"cookie","cookie"===b&&(c="|",d="#",e=/\|$/),"formdata"===b&&(c="&",d="=",e=/\&$/);for(var g=p.ObjectKeys(a),h=0;h<g.length;h++){var i=g[h];f+=i,"function"==typeof a[i].getTime?f+=d+p.b36_Date(a[i]):"object"==typeof a[i]&&null!==a[i]?f+=p.objectToStringVal(a[i]):(f+=d,f+="formdata"===b?encodeURIComponent(a[i]):a[i]),f+=c}return finalOutput=f.replace(e,""),"formdata"===b&&(finalOutput=finalOutput.replace(/%20/g,"+")),s("_util.objectToStringVal","To "+b+":","Output final:",finalOutput),finalOutput},p.cookieValToObject=function(a){for(var b={},c=a.split("|"),d=0;d<c.length;d++){var e,f;e=c[d].split("#"),e.length>1&&(f="c"===e[0]||"u"===e[0]?p.b36_toDate(e[1]):"true"===e[1]?!0:"false"===e[1]?!1:e[1],b[e[0]]=f)}return b},p.collateCookiesIntoTierArrays=function(a,b,c,d){"undefined"==typeof d&&(d=!1);var e=!1;"string"!=typeof b&&"string"!=typeof c&&(b="",c="",e=!0);var f={};f.asTestMatch={},f.asTestMatch.tier1=[],f.asTestMatch.tier2=[],f.asTestNotMatch={},f.asTestNotMatch.tier1=[],f.asTestNotMatch.tier2=[];for(var g=0,h=p.ObjectKeys(a),i=0;i<h.length;i++){var j,k=h[i];j=e?!0:~a[k].indexOf("v#"+b);var l=~a[k].indexOf("pid#"+c),m=~a[k].indexOf("test#1");if(r.asTest===!!m){var n={};l?(n[k]=p.cookieValToObject(a[k]),f.asTestMatch.tier1.push(n)):(n[k]=p.cookieValToObject(a[k]),f.asTestMatch.tier2.push(n))}else if(d)g++;else{var o={};l&&j?(o[k]=p.cookieValToObject(a[k]),f.asTestNotMatch.tier1.push(o)):j&&(o[k]=p.cookieValToObject(a[k]),f.asTestNotMatch.tier2.push(o))}}return s("_util.collateCookiesIntoTierArrays","Cookies not matching asTest state: "+g),f},p.latestDateSortCookieObjectArray=function(a,b){for(var c,d=p.ObjectKeys(a),e=0;e<d.length;e++){var f=d[e];c=a[f].u||a[f].c}for(var g,h=p.ObjectKeys(b),i=0;i<h.length;i++){var j=h[i];g=b[j].u||b[j].c}return g>c?1:c>g?-1:0},p.getAllCTMHCookiesAsString=function(){for(var a=b.cookie,c=a.split("; "),d="_CtMH",e=[],f=0;f<c.length;f++)c[f].slice(0,d.length)==d&&e.push(c[f]);return e.join("; ")},p.discoverCookieStats=function(){var a=p.getAllCTMHCookiesAsString(),b={};return b.bytes=2*a.length,b.count=a.split("; ").length,b},p.willTheCookieFit=function(a,b){var c=50,d=4093,e=o.utils.escape(b),f=a+"="+e+"; ",g=2*f.length,h=p.discoverCookieStats(),i={};return i.bytes=h.bytes+g,i.count=h.count+1,i.count<=c&&i.bytes<=d?!0:!1},p.setCookie=function(a,b){return f()?p.willTheCookieFit(a,b)?(o.set(a,b),!0):(s("_util.setCookie","ERROR! - No more cookie storage! Attempt after a purge."),g(),o.set(a,b),!1):void 0};var q=a._CtMH&&a._CtMH.options||{},r=p.extend({},m,q);d();var s=function(){r.debug&&a.console&&("undefined"!=typeof meerkat&&"undefined"!=typeof meerkat.logging.debug?meerkat.logging.debug("[CTMH]",Array.prototype.slice.call(arguments)):console.log("[CTMH] >",Array.prototype.slice.call(arguments)))},t={start:function(){},add:function(){},confirm:function(){},setOpts:function(){}};t.setOpts=function(a,b){if(f()){var c=Array.prototype.slice.call(arguments).join("|"),e=p.cookieValToObject(c);r=p.extend({},r,e),d(),s("_actions.setOpts","Inside:",r)}else if("object"==typeof a){b?s("callIframeOnly was set"):(r=p.extend({},r,a),d(),s("_actions.setOpts","Outside:",r));var g="setOpts="+p.objectToStringVal(a);s(g),i(g)}else s("_actions.setOpts: option overrides were not passed as an object.")},t.start=function(a,b){if(f()){var c="_CtMH"+a,d={c:new Date,v:b};r.asTest===!0&&(d.test=1);var e=p.objectToStringVal(d);s("_actions.start","Setting cookie with - key:",c,"value:",e),p.setCookie(c,e),h()}else if("undefined"==typeof a||"0"==a||""===a)s("_actions.start","[CRITICAL]","THERE IS NO VALID TRANSACTION ID PROVIDED. Failing.");else{var g="start="+Array.prototype.slice.call(arguments).join("|");s("_actions.start","passing message",g),i(g)}},t.add=function(a,b,c){if(f()){s("_actions.add","Additions requested on key "+a+":",b,c);var d="_CtMH"+a,e=o.get(d);if(e){s("_actions.add","Cookie val found for "+a+":",e);var g={u:new Date,pid:b,pd:c};s("_actions.add","Data we wish to add for "+a+":",g);var h=p.cookieValToObject(e),j=p.extend({},h,g);s("_actions.add","Merged data we will store for "+a+":",j);var k=p.objectToStringVal(j);p.setCookie(d,k)}else s("_actions.add","No cookie exists with this tid key. Cannot add to it.")}else{var l="add="+Array.prototype.slice.call(arguments).join("|");s("_actions.add","passing message",l),i(l)}},t.confirm=function(a){if(f()){s("_actions.confirm","process the confirm"),s("_actions.confirm - inside","cookie.enabled:",o.enabled());var b=Array.prototype.slice.call(arguments).join("|"),c=p.cookieValToObject(b),d=c.v,e=c.pid,g=c.policyno||"";if(d&&e){var j,k=o.all(),l=p.collateCookiesIntoTierArrays(k,d,e,!0);0===l.asTestMatch.tier1.length?(j=l.asTestMatch.tier2,s("_actions.confirm","asTestMatch.tier2",j)):(j=l.asTestMatch.tier1,s("_actions.confirm","asTestMatch.tier1",j));var m=j.length;if(0===m)return void s("_actions.confirm","No cookie candidates - do nothing.");m>1&&j.sort(p.latestDateSortCookieObjectArray);var n=j[0];s("_actions.confirm","winning cookie:",n);var q=p.ObjectKeys(n),t=q[0],u=t.split("_CtMH")[1],v=n[t];s("_actions.confirm","Cookie data we will store for "+u+":",v);var w;if((v.sent===!0||v.sent===!1)&&v.policyno==g)return s("_actions.confirm","Cookie "+u+" already sent once, and has the same policyno "+g+" - do nothing for this confirm."),s("We can do a recovery check just in case it was false:"),void h();v.sent===!0?(s("_actions.confirm","Cookie "+u+" already confirmed, but is a new policy - send anew with selective overwriting."),w=p.extend({},v,c),w.tid=v.tid,w.c=v.c,w.v=v.v,w.pid=v.pid,v.u&&(w.u=v.u),v.test&&(w.test=v.test),v.sent&&(w.sent=v.sent)):w=p.extend({},c,v),s("_actions.confirm","Merged data we will store for "+u+":",w);var x=p.objectToStringVal(w),y="_CtMH"+u;p.setCookie(y,x);var z=function(a,b){if("success"===b){s("Request success:",b,a.status,a);var c=a.responseText.toString().replace(/\s|\r|\n/g,"");'{"success":false}'===c?(w.sent=!1,x=p.objectToStringVal(w),p.setCookie(y,x)):'{"success":true}'===c?(w.sent=!0,x=p.objectToStringVal(w),p.setCookie(y,x),s("Cookie "+y+" accepted at endpoint. Marked sent."),s("Recovery check after successful confirm:"),h()):'{"success":"clear"}'===c?(o.remove(y),s("Cookie "+y+" deleted at endpoint's request.")):(w.sent=!1,x=p.objectToStringVal(w),p.setCookie(y,x))}else{s("Request failed:",b,a.status,a);var d=function(a){p.setCookie(y,p.objectToStringVal(a)),s("ERROR: Send",a.sent,"failed! Retrying (in 2 sec)..."),setTimeout(function(){p.sendRequest(r.endp,z,p.objectToStringVal(a,"formdata"))},2e3)};switch(w.sent){case"1":w.sent="2",d(w);break;case"2":w.sent=!1,p.setCookie(y,p.objectToStringVal(w)),s("ERROR: 3 attempts failed! False was set.");break;case!1:return;default:w.sent="1",d(w)}}};w.tid=u,p.sendRequest(r.endp,z,p.objectToStringVal(w,"formdata"))}}else{s("_actions.confirm - outside","cookie.enabled:",o.enabled());var A="confirm="+p.objectToStringVal(a);s("_actions.confirm","passing message",A),i(A)}},a._CtMH={purge:g,initFrame:e,setOpts:t.setOpts,add:t.add,confirm:t.confirm,start:t.start,init:l,onready:k}}(window,document),window._CtMH&&window._CtMH.init();
//# sourceMappingURL=ctmh.min.map